<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  deleteDoc, 
  doc, 
  updateDoc,
  query,
  where,
  getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCb7XMt8UZu6C5iWxcpdRPOKiME2SW5ONw",
  authDomain: "rekruteam.firebaseapp.com",
  projectId: "rekruteam",
  storageBucket: "rekruteam.firebasestorage.app",
  messagingSenderId: "159148318174",
  appId: "1:159148318174:web:c891f9ed8590ec9b55d14f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_PASSWORD="rekru123";

let mentors=[];
let students=[];

const rankNames={
5:"Chief",
4:"HQ",
3:"Senior Agent",
2:"Agent",
1:"Junior Agent"
};

const mentorTable=document.getElementById("mentorTable");
const studentTable=document.getElementById("studentTable");
const mentorCount=document.getElementById("mentorCount");
const studentCount=document.getElementById("studentCount");
const mentorSelect=document.getElementById("mentorSelect");
const mentorDeleteSelect=document.getElementById("mentorDeleteSelect");
const mentorChangeSelect=document.getElementById("mentorChangeSelect");
const studentDeleteSelect=document.getElementById("studentDeleteSelect");


// üî• REALTIME ‚Äì ka≈ºdy widzi zmiany od razu
onSnapshot(collection(db,"mentors"),snapshot=>{
mentors=[];
snapshot.forEach(d=>mentors.push({...d.data(),id:d.id}));
render();
});

onSnapshot(collection(db,"students"),snapshot=>{
students=[];
snapshot.forEach(d=>students.push({...d.data(),id:d.id}));
render();
});


function render(){

mentorTable.innerHTML="";
studentTable.innerHTML="";
mentorSelect.innerHTML="";
mentorDeleteSelect.innerHTML="";
mentorChangeSelect.innerHTML="";
studentDeleteSelect.innerHTML="";

mentors.sort((a,b)=>b.rank-a.rank);

mentorCount.textContent=mentors.length;
studentCount.textContent=students.length;

mentors.forEach(m=>{
mentorTable.innerHTML+=`
<tr>
<td>${m.name}</td>
<td>${m.uid}</td>
<td><span class="badge rank-${m.rank}">[${m.rank}] ${rankNames[m.rank]}</span></td>
</tr>`;

mentorSelect.add(new Option(m.name,m.id));
mentorDeleteSelect.add(new Option(m.name,m.id));
mentorChangeSelect.add(new Option(m.name,m.id));
});

students.forEach(s=>{
let mentor=mentors.find(m=>m.id===s.mentorID);

studentTable.innerHTML+=`
<tr>
<td>${s.name}</td>
<td>${s.uid}</td>
<td>${mentor?mentor.name:"Brak"}</td>
</tr>`;

studentDeleteSelect.add(new Option(s.name,s.id));
});
}


// üî• DODAJ MENTORA
window.addMentor=async function(){

if(!mentorUID.value || !mentorName.value)
return alert("Uzupe≈Çnij dane");

await addDoc(collection(db,"mentors"),{
uid:mentorUID.value,
name:mentorName.value,
rank:parseInt(mentorRank.value)
});

mentorUID.value="";
mentorName.value="";
}


// üî• DODAJ PODOPIECZNEGO
window.addStudent=async function(){

if(!studentUID.value || !studentName.value)
return alert("Uzupe≈Çnij dane");

await addDoc(collection(db,"students"),{
uid:studentUID.value,
name:studentName.value,
mentorID:mentorSelect.value
});

studentUID.value="";
studentName.value="";
}


// üî• USU≈É MENTORA + JEGO PODOPIECZNYCH
window.deleteMentor=async function(){

const mentorID=mentorDeleteSelect.value;

// usu≈Ñ podopiecznych tego mentora
const q=query(collection(db,"students"),where("mentorID","==",mentorID));
const snapshot=await getDocs(q);
snapshot.forEach(async (docSnap)=>{
await deleteDoc(doc(db,"students",docSnap.id));
});

// usu≈Ñ mentora
await deleteDoc(doc(db,"mentors",mentorID));
}


// üî• USU≈É PODOPIECZNEGO
window.deleteStudent=async function(){
await deleteDoc(doc(db,"students",studentDeleteSelect.value));
}


// üî• ZMIE≈É RANGƒò
window.changeRank=async function(){
await updateDoc(doc(db,"mentors",mentorChangeSelect.value),{
rank:parseInt(mentorChangeRank.value)
});
}


// üîê LOGIN
window.openLogin=function(){
loginModal.classList.add("active");
}

window.login=function(){
if(adminPass.value===ADMIN_PASSWORD){
loginModal.classList.remove("active");
adminModal.classList.add("active");
}else alert("Z≈Çe has≈Ço!");
}

window.closeAdmin=function(){
adminModal.classList.remove("active");
}
</script>
</body>
</html>
